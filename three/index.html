<!DOCTYPE html>
<html>
<head>
    <meta charset="utf-8">
    <title>My first three.js app</title>
    <style>
        body {
            margin: 0;
        }

        .input {
            width: 100%;
        }

        .button {
            width: 100%;
        }
    </style>
</head>
<body>
<label>obj</label>
<input class="input" name="obj" id="obj"
       value="https://core-ruangguru.s3.ap-southeast-1.amazonaws.com/3dobject/model.obj"/>
<label>mtl</label>
<input class="input" name="mtl" id="mtl"
       value="https://core-ruangguru.s3.ap-southeast-1.amazonaws.com/3dobject/model.mtl"/>
<button class="button" id="load">load</button>
<p id="progress"></p>
<script type="module">
    import {
        Scene,
        WebGLRenderer,
        PerspectiveCamera,
        AxesHelper,
        AmbientLight,
        GridHelper,
        MathUtils,
    } from './js/three.module.js'
    import {OBJLoader} from './js/objloader.module.js'
    import {MtlLoader} from './js/mtlloader.module.js'
    import {OrbitControls} from "./js/orbitcontrols.module.js";
    import Stats from "./js/stats.module.js";

    class App {

        constructor() {
            this.objURL = ""
            this.mtlURL = ""

            this.scene = this.prepareScene()

            this.camera = this.prepareCamera()
            this.renderer = this.prepareRenderer()
            this.stats = Stats()
            this.controls = new OrbitControls(this.camera, this.renderer.domElement)

            document.body.appendChild(this.renderer.domElement)
            // document.body.appendChild(this.stats.dom)

            window.addEventListener('resize', this.onWindowResize, false)

            document.querySelector("#load").addEventListener("click", this.load)

        }

        prepareScene = () => {
            const scene = new Scene();
            scene.add(new AmbientLight())
            scene.add(new GridHelper(12, 12));
            scene.add(new AxesHelper(10))
            return scene
        }

        resetScene = () => {
            this.scene = this.prepareScene()
        }

        onWindowResize = () => {
            this.camera.aspect = window.innerWidth / window.innerHeight
            this.camera.updateProjectionMatrix()
            this.renderer.setSize(window.innerWidth, window.innerHeight)
            this.render()
        }

        load = () => {
            this.setURL()
            this.resetScene()
            this.loadObjectAndMtl()
        }

        loadObjectAndMtl = () => {
            const mtlLoader = new MtlLoader()
            mtlLoader.load(this.mtlURL,
                (materials) => {
                    materials.preload()
                    const objLoader = new OBJLoader()
                    objLoader.setMaterials(materials)
                    objLoader.load(this.objURL,
                        (object) => {
                            object.position.y = 2
                            object.rotateX(MathUtils.degToRad(-90));
                            object.rotateY(MathUtils.degToRad(0));
                            object.rotateZ(MathUtils.degToRad(0));
                            this.scene.add(object)
                        },
                        (xhr) => {
                            const progress = (xhr.loaded / xhr.total) * 100 + '% loaded'
                            document.querySelector("#progress").innerHTML = progress
                            console.log(progress)
                        },
                        (error) => console.log('An error happened', error)
                    )
                },
                (xhr) => console.log((xhr.loaded / xhr.total) * 100 + '% loaded'),
                (error) => console.log(error)
            )
        }

        setURL = () => {
            this.objURL = document.querySelector("#obj").value
            this.mtlURL = document.querySelector("#mtl").value
        }

        prepareCamera = () => {
            const camera = new PerspectiveCamera(45,
                window.innerWidth / window.innerHeight,
                0.1,
                1000
            )
            camera.position.set(6, 8, 14);
            return camera
        }

        prepareRenderer = () => {
            const renderer = new WebGLRenderer({
                antiAlias: true
            })
            renderer.setSize(window.innerWidth, window.innerHeight)
            renderer.setClearColor(0xFEFEFE)
            return renderer
        }

        render = () => {
            this.renderer.render(this.scene, this.camera)
        }

        animate = () => {
            requestAnimationFrame(this.animate)
            this.controls.update()
            this.render()
            this.stats.update()
        }
    }

    const app = new App()

    function animate() {
        app.animate()
    }

    animate()

</script>
</body>
</html>